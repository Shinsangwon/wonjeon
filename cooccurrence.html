<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>문자열 동시 출현 검색기 (거리 기반)</title>
<style>
  :root{
    --bg:#0b0c10; --card:#11141a; --ink:#e6e7eb; --muted:#9aa3b2;
    --accent:#4f8cff; --a1:#ffd166; --a2:#7bd389; --chip:#1b2130;
    --border:#2a3140;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
    background:var(--bg); color:var(--ink); line-height:1.55;
  }
  header{padding:24px}
  header h1{margin:0 0 4px; font-size:22px}
  header p{margin:0;color:var(--muted)}
  .wrap{display:grid; grid-template-columns: 340px 1fr; gap:16px; padding:16px}
  .panel{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}
  label{display:block; font-size:13px; color:var(--muted); margin:12px 0 6px}
  input[type="text"], input[type="url"], input[type="number"], textarea{
    width:100%; background:#0e121a; color:var(--ink); border:1px solid var(--border);
    border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
  }
  textarea{min-height:200px; resize:vertical}
  .row{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
  .chk{display:flex; align-items:center; gap:8px; margin-top:6px; font-size:13px; color:var(--muted)}
  .btnbar{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
  button{
    background:var(--accent); color:white; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;
  }
  button.ghost{background:var(--chip); color:var(--ink)}
  button.secondary{background:#1c2230}
  .stats{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px}
  .chip{
    background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)
  }
  .result{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin:10px 0}
  .result h4{margin:0 0 6px; font-size:14px}
  .result p{margin:6px 0 0; white-space:pre-wrap}
  mark{padding:0 2px; border-radius:4px}
  mark.t1{background:rgba(255,209,102,0.35); outline:1px solid rgba(255,209,102,0.4)}
  mark.t2{background:rgba(123,211,137,0.35); outline:1px solid rgba(123,211,137,0.4)}
  .muted{color:var(--muted)}
  .fulltext{max-height:40vh; overflow:auto; border:1px dashed var(--border); padding:12px; border-radius:10px; background:#0e121a}
  .footer{padding:16px; color:var(--muted); font-size:12px}
  .linklike{color:var(--accent); cursor:pointer; text-decoration:underline}
  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <h1>문자열 동시 출현 검색기 · 거리기반</h1>
  <p>두 문자열 A/B가 <strong>N</strong> 글자 이내에서 함께 쓰인 구간을 찾아 하이라이트합니다.</p>
</header>

<div class="wrap">
  <!-- 왼쪽: 입력/설정 -->
  <section class="panel">
    <label>텍스트 붙여넣기</label>
    <textarea id="textInput" placeholder="여기에 텍스트를 붙여넣으세요."></textarea>

    <div class="btnbar">
      <input type="file" id="fileInput" accept=".txt,.csv,.tsv,.md,.json,.html,.htm" />
      <button class="ghost" id="loadFileBtn">파일 불러오기</button>
      <input type="url" id="urlInput" placeholder="http:// 또는 https:// 주소 입력" />
      <button class="ghost" id="loadUrlBtn">URL 불러오기</button>
      <button class="secondary" id="clearBtn">초기화</button>
    </div>

    <div class="row">
      <div>
        <label>문자열 A</label>
        <input type="text" id="termA" placeholder="예: 孟子">
      </div>
      <div>
        <label>문자열 B</label>
        <input type="text" id="termB" placeholder="예: 王">
      </div>
    </div>

    <div class="row">
      <div>
        <label>허용 간격 N (문자 수)</label>
        <input type="number" id="maxGap" value="10" min="0" step="1">
      </div>
      <div>
        <label>문맥 길이 (좌/우)</label>
        <input type="number" id="ctx" value="20" min="0" step="1">
      </div>
    </div>

    <div class="row">
      <div class="chk">
        <input type="checkbox" id="ignoreSpaces" checked>
        <label for="ignoreSpaces">공백 무시</label>
      </div>
      <div class="chk">
        <input type="checkbox" id="ignorePunct" checked>
        <label for="ignorePunct">문장부호 무시</label>
      </div>
    </div>
    <div class="row">
      <div class="chk">
        <input type="checkbox" id="ignoreTradSimpl">
        <label for="ignoreTradSimpl">간번체 차이 무시</label>
      </div>
    </div>

    <div class="btnbar">
      <button id="runBtn">검색 실행</button>
      <button class="ghost" id="showFullBtn" disabled>전체 텍스트 보기</button>
      <button class="ghost" id="exportBtn" disabled>CSV 내보내기</button>
    </div>
    <label>추가 검색어 (결과 내 검색)</label>
    <input type="text" id="refineTerm" placeholder="예: 君子">
    <button class="secondary" id="refineBtn" disabled>결과 내 검색</button>
  </section>

  <!-- 오른쪽: 결과 -->
  <section class="panel">
    <div class="stats" id="stats" style="display:none"></div>
    <div id="results"></div>
    <div id="fullTextWrap" style="display:none; margin-top:12px">
      <h3 style="margin:4px 0 8px">전체 텍스트 (하이라이트)</h3>
      <div class="fulltext" id="fullText"></div>
    </div>
  </section>
</div>

<div class="footer">
  ※ URL 불러오기는 CORS 차단 사이트에서는 동작하지 않을 수 있습니다.  
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);

  const textInput = $("#textInput");
  const fileInput = $("#fileInput");
  const loadFileBtn = $("#loadFileBtn");
  const loadUrlBtn = $("#loadUrlBtn");
  const urlInput = $("#urlInput");
  const clearBtn = $("#clearBtn");
  const termA = $("#termA");
  const termB = $("#termB");
  const maxGap = $("#maxGap");
  const ctx = $("#ctx");
  const ignoreSpaces = $("#ignoreSpaces");
  const ignorePunct = $("#ignorePunct");
  const ignoreTradSimpl = $("#ignoreTradSimpl");
  const runBtn = $("#runBtn");
  const showFullBtn = $("#showFullBtn");
  const exportBtn = $("#exportBtn");
  const refineTerm = $("#refineTerm");
  const refineBtn = $("#refineBtn");
  const statsBox = $("#stats");
  const resultsBox = $("#results");
  const fullTextWrap = $("#fullTextWrap");
  const fullText = $("#fullText");

  let lastSearchState = null;

  // 간↔번 간단 매핑 (예시, 확장 가능)
  const simpToTrad = {"汉":"漢","医":"醫","国":"國","气":"氣","马":"馬","东":"東","书":"書"};
  const tradToSimp = {}; for(const k in simpToTrad){ tradToSimp[simpToTrad[k]]=k; }

  function convertTradSimpl(ch){
    if(simpToTrad[ch]) return simpToTrad[ch];
    if(tradToSimp[ch]) return tradToSimp[ch];
    return ch;
  }

  loadFileBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const txt = await f.text();
    textInput.value = txt;
  });

  loadUrlBtn.addEventListener("click", async ()=>{
    const url = urlInput.value.trim();
    if(!url){ alert("URL을 입력하세요."); return; }
    try{
      const res = await fetch(url);
      const html = await res.text();
      const body = html.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"");
      textInput.value = body.replace(/<[^>]+>/g,""); // 태그 제거
    }catch(e){
      alert("불러오기 실패: CORS 차단일 수 있습니다.");
    }
  });

  clearBtn.addEventListener("click", () => {
    textInput.value = ""; termA.value = ""; termB.value = "";
    resultsBox.innerHTML = ""; statsBox.style.display = "none";
    fullTextWrap.style.display = "none"; showFullBtn.disabled = true; exportBtn.disabled = true;
    lastSearchState = null; refineBtn.disabled = true;
  });

  runBtn.addEventListener("click", () => {
    searchAndRender();
  });

  refineBtn.addEventListener("click", () => {
    if(!lastSearchState) return;
    const term = refineTerm.value.trim();
    if(!term){ alert("추가 검색어를 입력하세요."); return; }
    const filtered = lastSearchState.mappedPairs.filter(p=>{
      const snippet = stripHtml(p.snippetHtml);
      return snippet.includes(term);
    });
    renderResults(filtered);
  });

  function searchAndRender(){
    const raw = textInput.value || "";
    const a = termA.value || "";
    const b = termB.value || "";
    const N = parseInt(maxGap.value, 10) || 0;
    const contextLen = parseInt(ctx.value, 10) || 0;
    if(!raw.trim()){ alert("텍스트를 입력하세요."); return; }
    if(!a){ alert("문자열 A를 입력하세요."); return; }
    if(!b){ alert("문자열 B를 입력하세요."); return; }

    const options = {
      ignoreSpaces: ignoreSpaces.checked,
      ignorePunct: ignorePunct.checked,
      ignoreTradSimpl: ignoreTradSimpl.checked
    };

    const norm = normalizeWithMap(raw, options);
    const na = normalizeTerm(a, options);
    const nb = normalizeTerm(b, options);

    const occA = findAllOccurrences(norm.normStr, na);
    const occB = findAllOccurrences(norm.normStr, nb);

    const pairs = matchPairsWithinGap(occA, occB, N, na.length, nb.length);

    const mappedPairs = pairs.map((p, idx) => {
      const aStartOrig = norm.normToOrig[p.aStart];
      const aEndOrig   = norm.normToOrig[p.aStart + na.length - 1];
      const bStartOrig = norm.normToOrig[p.bStart];
      const bEndOrig   = norm.normToOrig[p.bStart + nb.length - 1];
      const left = Math.min(aStartOrig, bStartOrig);
      const right= Math.max(aEndOrig, bEndOrig);
      const c0 = Math.max(0, left - contextLen);
      const c1 = Math.min(raw.length - 1, right + contextLen);
      const snippetInfo = makeSnippet(raw, c0, c1, [
        {start:aStartOrig, end:aEndOrig, cls:"t1"},
        {start:bStartOrig, end:bEndOrig, cls:"t2"},
      ]);
      return {
        index: idx + 1, aStartNorm: p.aStart, bStartNorm: p.bStart,
        gap: p.gap, snippetHtml: snippetInfo.html,
        anchorAtOrig: left
      };
    });

    renderStats({raw, a, b, na, nb, occA, occB, pairs});
    renderResults(mappedPairs);

    lastSearchState = { raw, a, b, na, nb, options, mappedPairs };
    showFullBtn.disabled = false;
    exportBtn.disabled = mappedPairs.length === 0;
    refineBtn.disabled = mappedPairs.length === 0;
    fullTextWrap.style.display = "none";
  }

  // ===== 유틸 =====
  const PUNCT_FALLBACK = /[.,;:!?'"`~\-–—_()[\]{}<>\/\\|@#$%^&*+=，、。．？！：；「」『』（）《》〈〉【】—…·・＂＇．､｡､]/g;
  const SPACE_REGEX = /[\s\u3000]/g;

  function normalizeWithMap(str,opt){
    let norm = "", map = [];
    for(let i=0;i<str.length;i++){
      let ch = str[i];
      PUNCT_FALLBACK.lastIndex=0; SPACE_REGEX.lastIndex=0;
      if(opt.ignoreSpaces && SPACE_REGEX.test(ch)) continue;
      if(opt.ignorePunct && PUNCT_FALLBACK.test(ch)) continue;
      if(opt.ignoreTradSimpl) ch = convertTradSimpl(ch);
      norm += ch; map.push(i);
    }
    return {normStr:norm,normToOrig:map};
  }

  function normalizeTerm(term,opt){
    let t=term;
    if(opt.ignoreSpaces) t=t.replace(SPACE_REGEX,"");
    if(opt.ignorePunct) t=t.replace(PUNCT_FALLBACK,"");
    if(opt.ignoreTradSimpl) t=[...t].map(convertTradSimpl).join("");
    return t;
  }

  function findAllOccurrences(text,pat){
    const out=[]; let i=0;
    while(true){ const idx=text.indexOf(pat,i); if(idx==-1) break; out.push(idx); i=idx+1; }
    return out;
  }

  function matchPairsWithinGap(occA,occB,N,lenA,lenB){
    const res=[]; let j=0;
    for(let i=0;i<occA.length;i++){
      const aS=occA[i], aE=aS+lenA-1;
      while(j<occB.length && occB[j]+lenB-1<aS-N) j++;
      for(let k=j;k<occB.length;k++){
        const bS=occB[k], bE=bS+lenB-1;
        if(bS>aE+N) break;
        const gap=intervalGap(aS,aE,bS,bE);
        if(gap<=N) res.push({aStart:aS,bStart:bS,gap});
      }
    }
    return res;
  }

  function intervalGap(aS,aE,bS,bE){
    if(aS<=bE && bS<=aE) return 0;
    if(aE<bS) return bS-aE-1;
    if(bE<aS) return aS-bE-1;
    return 0;
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  function makeSnippet(raw,start,end,ranges){
    const slice=raw.slice(start,end+1);
    const localRanges=ranges.map(r=>({start:r.start-start,end:r.end-start,cls:r.cls})).filter(r=>r.start>=0&&r.end<=slice.length);
    return {html:decorateRanges(escapeHtml(slice),localRanges)};
  }

  function decorateRanges(textHtml,ranges){
    const sorted=[...ranges].sort((x,y)=>y.start-x.start);
    let html=textHtml;
    for(const r of sorted){
      html=html.slice(0,r.start)+"<mark class='"+r.cls+"'>"+html.slice(r.start,r.end+1)+"</mark>"+html.slice(r.end+1);
    }
    return html;
  }

  function renderStats({raw,a,b,na,nb,occA,occB,pairs}){
    statsBox.style.display="flex";
    statsBox.innerHTML=`
      <span class="chip">A: ${escapeHtml(a)} (${na.length})</span>
      <span class="chip">B: ${escapeHtml(b)} (${nb.length})</span>
      <span class="chip">A 발생 ${occA.length}회</span>
      <span class="chip">B 발생 ${occB.length}회</span>
      <span class="chip">동시출현 ${pairs.length}쌍</span>
      <span class="chip">텍스트 길이 ${raw.length}자</span>`;
  }

  function renderResults(items){
    resultsBox.innerHTML="";
    if(items.length==0){resultsBox.innerHTML="<div class='muted'>결과 없음</div>"; return;}
    items.forEach(r=>{
      const div=document.createElement("div");
      div.className="result";
      div.innerHTML=`<h4>#${r.index} · 간격 ${r.gap}자</h4><p>${r.snippetHtml}</p>`;
      resultsBox.appendChild(div);
    });
  }

  function stripHtml(html){
    const tmp=document.createElement("div"); tmp.innerHTML=html; return tmp.textContent||"";
  }

})();
</script>
</body>
</html>
